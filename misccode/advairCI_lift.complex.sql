
--SELECT PRODUCT, MATERIAL_BATCH_NUMBER, TO_CHAR(MFG_DATE, 'MM-DD-YY') as mfg_date, test_method_description, RECORDED_TEXT, NUMERIC_RESULT_UNIT, replicate_id, IMPACTOR_NUMBER, CHARACTER_RESULT, METHOD_ID, TEST_STATUS, TO_CHAR(TEST_EXECUTION_DATE, 'MM-DD-YY') as TEST_EXECUTION_DATE, ANALYST_ID, BLEND_NUMBER, BLEND_MFG_DATE, BLEND_MATL_DESCRIPTION, FILL_BATCH, to_char(FILL_MFG_DATE, 'MM-DD-YY HH:MM') as FILL_MFG_DATE, FILL_MATL_DESCRIPTION, AP_BATCH, to_char(AP_MFG_DATE, 'MM-DD-YY HH:MM') as AP_MFG_DATE, AP_MATL_DESCRIPTION, fill_group1, fill_group2, strength, dose , strength2, dose2, td1,td2
SELECT PRODUCT, MATERIAL_BATCH_NUMBER, TO_CHAR(MFG_DATE, 'MM-DD-YY') as mfg_date, test_method_description, RECORDED_TEXT, NUMERIC_RESULT_UNIT, replicate_id, IMPACTOR_NUMBER, CHARACTER_RESULT, METHOD_ID, TEST_STATUS, TO_CHAR(TEST_EXECUTION_DATE, 'MM-DD-YY') as TEST_EXECUTION_DATE, ANALYST_ID, BLEND_NUMBER, BLEND_MFG_DATE, BLEND_MATL_DESCRIPTION, FILL_BATCH, to_char(FILL_MFG_DATE, 'MM-DD-YY HH:MM') as FILL_MFG_DATE, FILL_MATL_DESCRIPTION, AP_BATCH, to_char(AP_MFG_DATE, 'MM-DD-YY HH:MM') as AP_MFG_DATE, AP_MATL_DESCRIPTION
FROM (
  SELECT
    (CASE WHEN T1.MATERIAL_DESCRIPTION LIKE '%%100/50%%' THEN 'Advair Diskus 100/50'
          WHEN T1.MATERIAL_DESCRIPTION LIKE '%%250/50%%' THEN 'Advair Diskus 250/50'
          WHEN T1.MATERIAL_DESCRIPTION LIKE '%%500/50%%' THEN 'Advair Diskus 500/50'
     ELSE T1.MATERIAL_DESCRIPTION
     END) PRODUCT,
    T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID AS material_batch_number, T2.LAST_GOODS_RECEIPT_DT AS mfg_date, T1.TEST_ID, T1.COMPONENT_ID, T1.TEST_RESULT_TYPE,
    (CASE WHEN (( T1.TEST_ID LIKE '%%TP0%%' AND COMPONENT_ID='FluticasonePropionat' AND T1.TEST_RESULT_TYPE='RSpl_Content') OR (T1.TEST_RESULT_TYPE LIKE '%%TP0_FP%%')) THEN 'HPLC Advair MDPl Cas. Impaction-TP0-FLUTICASONE'
          WHEN (( T1.TEST_ID LIKE '%%TP0%%' AND COMPONENT_ID='Salmeterol' AND TEST_RESULT_TYPE='RSpl_Content') OR (T1.TEST_RESULT_TYPE LIKE '%%TP0_SX%%')) THEN 'HPLC Advair MDPl Cas. Impaction-TP0-SALMETEROL'
          WHEN (((T1.TEST_ID LIKE '%%S12%%') OR (T1.TEST_ID IN ('PLT00014611CI_G1','PLT00014612CI_G2','PLT00014613CI_G3','PLT00014614CI_G4') AND T1.REPLICATE_ID IN ('2','7','12','17')) OR (T1.TEST_ID IN ('PLT00014615CI2_G1','PLT00014616CI2_G2','PLT00014617CI2_G3','PLT00014618CI2_G4') AND T1.REPLICATE_ID IN ('2','7') )) AND COMPONENT_ID='FluticasonePropionat' AND TEST_RESULT_TYPE='RSpl_Content') THEN 'HPLC Advair MDPl Cas. Impaction-1-2-FLUTICASONE'
          WHEN (((T1.TEST_ID LIKE '%%S12%%') OR (T1.TEST_ID IN ('PLT00014611CI_G1','PLT00014612CI_G2','PLT00014613CI_G3','PLT00014614CI_G4') AND T1.REPLICATE_ID IN ('2','7','12','17')) OR (T1.TEST_ID IN ('PLT00014615CI2_G1','PLT00014616CI2_G2','PLT00014617CI2_G3','PLT00014618CI2_G4') AND T1.REPLICATE_ID IN ('2','7') )) AND COMPONENT_ID='Salmeterol' AND TEST_RESULT_TYPE='RSpl_Content') THEN 'HPLC Advair MDPl Cas. Impaction-1-2-SALMETEROL'
          WHEN (( T1.TEST_ID LIKE '%%S34%%' AND COMPONENT_ID='FluticasonePropionat' AND TEST_RESULT_TYPE='RSpl_Content') OR T1.TEST_RESULT_TYPE LIKE '%%3_4_FP%%') THEN 'HPLC Advair MDPl Cas. Impaction-3-4-FLUTICASONE'
          WHEN (( T1.TEST_ID LIKE '%%S34%%' AND COMPONENT_ID='Salmeterol' AND TEST_RESULT_TYPE='RSpl_Content') OR T1.TEST_RESULT_TYPE LIKE '%%3_4_SX%%') THEN 'HPLC Advair MDPl Cas. Impaction-3-4-SALMETEROL'
          WHEN (( T1.TEST_ID LIKE '%%S5%%'  AND COMPONENT_ID='FluticasonePropionat' AND TEST_RESULT_TYPE='RSpl_Content') OR (((T1.TEST_ID IN ('PLT00014611CI_G1','PLT00014612CI_G2','PLT00014613CI_G3','PLT00014614CI_G4') AND T1.REPLICATE_ID IN ('4','9','14','19')) OR (T1.TEST_ID IN ('PLT00014615CI2_G1','PLT00014616CI2_G2','PLT00014617CI2_G3','PLT00014618CI2_G4') AND T1.REPLICATE_ID IN ('4','9'))) AND COMPONENT_ID='FluticasonePropionat' AND TEST_RESULT_TYPE='RSpl_Content')) THEN 'HPLC Advair MDPl Cas. Impaction-5-FLUTICASONE'
          WHEN (( T1.TEST_ID LIKE '%%S5%%'  AND COMPONENT_ID='Salmeterol' AND TEST_RESULT_TYPE='RSpl_Content') OR (((T1.TEST_ID IN ('PLT00014611CI_G1','PLT00014612CI_G2','PLT00014613CI_G3','PLT00014614CI_G4') AND T1.REPLICATE_ID IN ('4','9','14','19')) OR (T1.TEST_ID IN ('PLT00014615CI2_G1','PLT00014616CI2_G2','PLT00014617CI2_G3','PLT00014618CI2_G4') AND T1.REPLICATE_ID IN ('4','9'))) AND COMPONENT_ID='Salmeterol' AND TEST_RESULT_TYPE='RSpl_Content')) THEN 'HPLC Advair MDPl Cas. Impaction-5-SALMETEROL'
          WHEN (( T1.TEST_ID LIKE '%%67F%%' AND COMPONENT_ID='FluticasonePropionat' AND TEST_RESULT_TYPE='RSpl_Content') OR T1.TEST_RESULT_TYPE LIKE '%%St6_Filter_FP%%') THEN 'HPLC Advair MDPl Cas. Impaction-6-F-FLUTICASONE'
          WHEN (( T1.TEST_ID LIKE '%%67F%%' AND COMPONENT_ID='Salmeterol' AND TEST_RESULT_TYPE = 'RSpl_Content') OR T1.TEST_RESULT_TYPE LIKE '%%St6_Filter_SX%%') THEN 'HPLC Advair MDPl Cas. Impaction-6-F-SALMETEROL'
          WHEN (T1.TEST_RESULT_TYPE LIKE '%%Sum_St1_5_FP%%') THEN 'HPLC Advair MDPl Cas. Impaction-1-5-FLUTICASONE'
          WHEN (T1.TEST_RESULT_TYPE LIKE '%%Sum_St1_5_SX%%') THEN 'HPLC Advair MDPl Cas. Impaction-1-5-SALMETEROL'
          WHEN (T1.TEST_ID IN ('PLT00014733','PLT00014735','PLT00014093','PLT00014206','PLT00015301','PLT00015303','PLT00014210','PLT00014230') AND UPPER(TEST_RESULT_TYPE)='RESULT') THEN 'HPLC Advair MDPl Cas. Impaction-Total-FLUTICASONE'
          WHEN (T1.TEST_ID IN ('PLT00014734','PLT00014736','PLT00014095','PLT00014208','PLT00015302','PLT00015304','PLT00014228','PLT00014272') AND UPPER(TEST_RESULT_TYPE)='RESULT') THEN 'HPLC Advair MDPl Cas. Impaction-Total-SALMETEROL'
    END) test_method_description,
    T1.RECORDED_TEXT, 'TBD' as Numeric_Result_Unit,
    (CASE WHEN (T1.TEST_ID IN ('PLT00014733','PLT00014735','PLT00014093','PLT00014206','PLT00014734','PLT00014736','PLT00014095','PLT00014208') AND UPPER(T1.COMPONENT_ID) LIKE '%%SAMPLE1') THEN '1'
          WHEN (T1.TEST_ID IN ('PLT00014733','PLT00014735','PLT00014093','PLT00014206','PLT00014734','PLT00014736','PLT00014095','PLT00014208') AND UPPER(T1.COMPONENT_ID) LIKE '%%SAMPLE2') THEN '2'
          WHEN (T1.TEST_ID IN ('PLT00014733','PLT00014735','PLT00014093','PLT00014206','PLT00014734','PLT00014736','PLT00014095','PLT00014208') AND UPPER(T1.COMPONENT_ID) LIKE '%%SAMPLE3') THEN '3'
          WHEN (T1.TEST_ID IN ('PLT00014733','PLT00014735','PLT00014093','PLT00014206','PLT00014734','PLT00014736','PLT00014095','PLT00014208') AND UPPER(T1.COMPONENT_ID) LIKE '%%SAMPLE4') THEN '4'
          WHEN (T1.TEST_ID IN ('PLT00015301','PLT00015303','PLT00014210','PLT00014230','PLT00015302','PLT00015304','PLT00014228','PLT00014272') AND UPPER(T1.COMPONENT_ID) LIKE '%%SAMPLE1') THEN '5'
          WHEN (T1.TEST_ID IN ('PLT00015301','PLT00015303','PLT00014210','PLT00014230','PLT00015302','PLT00015304','PLT00014228','PLT00014272') AND UPPER(T1.COMPONENT_ID) LIKE '%%SAMPLE2') THEN '6'
          WHEN (T1.TEST_ID IN ('PLT00014611CI_G1','PLT00014612CI_G2','PLT00014613CI_G3',' PLT00014614CI_G4')    AND T1.REPLICATE_ID IN ('2','4'))   THEN '1'
          WHEN (T1.TEST_ID IN ('PLT00014611CI_G1','PLT00014612CI_G2','PLT00014613CI_G3',' PLT00014614CI_G4')    AND T1.REPLICATE_ID IN ('7','9'))   THEN '2'
          WHEN (T1.TEST_ID IN ('PLT00014611CI_G1','PLT00014612CI_G2','PLT00014613CI_G3',' PLT00014614CI_G4')    AND T1.REPLICATE_ID IN ('12','14')) THEN '3'
          WHEN (T1.TEST_ID IN ('PLT00014611CI_G1','PLT00014612CI_G2','PLT00014613CI_G3',' PLT00014614CI_G4')    AND T1.REPLICATE_ID IN ('17','19')) THEN '4'
          WHEN (T1.TEST_ID IN ('PLT00014615CI2_G1','PLT00014616CI2_G2','PLT00014617CI2_G3','PLT00014618CI2_G4') AND T1.REPLICATE_ID IN ('2','4'))   THEN '5'
          WHEN (T1.TEST_ID IN ('PLT00014615CI2_G1','PLT00014616CI2_G2','PLT00014617CI2_G3','PLT00014618CI2_G4') AND T1.REPLICATE_ID IN ('7','9'))   THEN '6'
    ELSE T1.REPLICATE_ID
    END) replicate_id,
    'TBD' AS impactor_number, 'N/A' AS character_result, T1.METHOD_ID AS method_id, T1.TEST_STATUS AS test_status, T1.TEST_EXECUTION_DATE, T1.ANALYST_ID, 'BLEND BATCH' AS blend_number, 'BLEND BATCH MFG_DATE' AS blend_mfg_date, 'BLEND BATCH DESCRIPTION' AS blend_matl_description,
    (CASE WHEN (T1.TEST_ID LIKE '%%G1%%' )                     THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 1'
          WHEN (T1.TEST_ID LIKE '%%G2%%' )                     THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 2'
          WHEN (T1.TEST_ID LIKE '%%G3%%')                      THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 3'
          WHEN (T1.TEST_ID LIKE '%%G4%%' )                     THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 4'
          WHEN (UPPER(T1.TEST_DESCRIPTION) LIKE '%%GROUP 1%%') THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 1'
          WHEN (UPPER(T1.TEST_DESCRIPTION) LIKE '%%GROUP 2%%') THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 2'
          WHEN (UPPER(T1.TEST_DESCRIPTION) LIKE '%%GROUP 3%%') THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 3'
          WHEN (UPPER(T1.TEST_DESCRIPTION) LIKE '%%GROUP 4%%') THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 4'
          WHEN (T1.TEST_RESULT_TYPE LIKE '%%G1')               THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 1'
          WHEN (T1.TEST_RESULT_TYPE LIKE '%%G2')               THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 2'
          WHEN (T1.TEST_RESULT_TYPE LIKE '%%G3')               THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 3'
          WHEN (T1.TEST_RESULT_TYPE LIKE '%%G4')               THEN T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID||'-FILL BATCH 4'
    END) fill_group1,
    T1.MRP_MAT_ID||'-'|| T1.MRP_BATCH_ID AS ap_batch, T2.LAST_GOODS_RECEIPT_DT AS ap_mfg_date, T1.MATERIAL_DESCRIPTION AS ap_matl_description, REPLACE(REGEXP_SUBSTR(UPPER(T1.MATERIAL_DESCRIPTION),'\d+/[^/]* *MCG'), ' ','') as strength, REGEXP_SUBSTR(UPPER(T1.MATERIAL_DESCRIPTION),' [^ ]\d+D') as dose , T1.TEST_DESCRIPTION as td1
  FROM ODS_DIST.VW_ZEB_COMBINED_QCRESULTS_NL T1, ODS_DIST.VW_ZEB_MERPS_MATERIAL_BATCH T2
  WHERE T1.TEST_EXECUTION_DATE BETWEEN TO_DATE('01NOV10','DDMONYY') AND TO_DATE('15DEC10','DDMONYY')
        AND T2.MAT_COD=T1.MRP_MAT_ID
        AND T2.BAT_NUM=T1.MRP_BATCH_ID
        AND (UPPER(T1.MATERIAL_DESCRIPTION) LIKE '%%ADVAIR%%DISKUS%%' AND T1.TEST_DESCRIPTION LIKE ('%%Cascade%%')
        AND ((T1.TEST_ID IN ('PLT00014733','PLT00014735','PLT00014093','PLT00014206','PLT00015301','PLT00015303','PLT00014210','PLT00014230','PLT00014734','PLT00014736','PLT00014095','PLT00014208','PLT00015302','PLT00015304','PLT00014228','PLT00014272') AND T1.TEST_RESULT_TYPE='Result')
          OR (T1.TEST_ID IN ('PLT00014611CI_G1','PLT00014612CI_G2','PLT00014613CI_G3', 'PLT00014614CI_G4')    AND REPLICATE_ID IN ('2','4','7','9','12','14','17','19') AND T1.TEST_RESULT_TYPE='RSpl_Content')
          OR (T1.TEST_ID IN ('PLT00014615CI2_G1','PLT00014616CI2_G2','PLT00014617CI2_G3','PLT00014618CI2_G4') AND REPLICATE_ID IN ('2','4','7','9') AND T1.TEST_RESULT_TYPE='RSpl_Content')
          OR (T1.TEST_ID IN ('PLT00014126CI_S12G1','PLT00014156CI_S12G2','PLT00015228CI_S12G3','PLT00015238CI_S12G4','PLT00015259CI2S12G1','PLT00015269CI2S12G2','PLT00014003CI2S12G3','PLT00014077CI2S12G4') AND T1.TEST_RESULT_TYPE='RSpl_Content')
          OR (T1.TEST_ID IN ('%%PLT00014150CI_S5G1','PLT00014177CI_S5G2','PLT00015232CI_S5G3','PLT00015242CI_S5G4','PLT00015263CI2S5G1','PLT00015273CI2S5G2','PLT00014047CI2S5G3','PLT00014082CI2S5G4') AND T1.TEST_RESULT_TYPE='RSpl_Content')
          OR (T1.TEST_RESULT_TYPE LIKE '%%Sum_St1_5_FP%%')
          OR (T1.TEST_RESULT_TYPE LIKE '%%Sum_St1_5_SX%%')
          OR (T1.TEST_RESULT_TYPE LIKE '%%Stage_TP0_FP%%')
          OR (T1.TEST_RESULT_TYPE LIKE '%%Stage_TP0_SX%%')
          OR (T1.TEST_RESULT_TYPE LIKE '%%Stage_3_4_FP%%')
          OR (T1.TEST_RESULT_TYPE LIKE '%%Stage_3_4_SX%%')
          OR (T1.TEST_RESULT_TYPE LIKE '%%Sum_St6_Filter_FP%%')
          OR (T1.TEST_RESULT_TYPE LIKE '%%Sum_St6_Filter_SX%%')
        )
      )
) -- end FROM
LEFT JOIN
  (SELECT DISTINCT
    (CASE WHEN (UPPER(T3.TEST_DESCRIPTION) LIKE '%%GROUP 1%%') THEN T3.MRP_MAT_ID||'-'|| T3.MRP_BATCH_ID||'-FILL BATCH 1'
          WHEN (UPPER(T3.TEST_DESCRIPTION) LIKE '%%GROUP 2%%') THEN T3.MRP_MAT_ID||'-'|| T3.MRP_BATCH_ID||'-FILL BATCH 2'
          WHEN (UPPER(T3.TEST_DESCRIPTION) LIKE '%%GROUP 3%%') THEN T3.MRP_MAT_ID||'-'|| T3.MRP_BATCH_ID||'-FILL BATCH 3'
          WHEN (UPPER(T3.TEST_DESCRIPTION) LIKE '%%GROUP 4%%') THEN T3.MRP_MAT_ID||'-'|| T3.MRP_BATCH_ID||'-FILL BATCH 4'
    END) fill_group2,
    T5.MAT_DESC AS fill_matl_description, T4.LAST_GOODS_RECEIPT_DT AS fill_mfg_date, T4.MAT_COD||'-'||T3.RECORDED_TEXT AS fill_batch,
    --REPLACE(REGEXP_SUBSTR(UPPER(T5.MAT_DESC),'\d+/[^/]* *MCG'), ' ','') as strength2, REGEXP_SUBSTR(UPPER(T5.MAT_DESC),' [^ ]\d+D') as dose2, TEST_DESCRIPTION as td2
    REPLACE(REGEXP_SUBSTR(UPPER(T5.MAT_DESC),'\d+/[^/]* *MCG'), ' ','') as strength2, REGEXP_SUBSTR(UPPER(T5.MAT_DESC),' [^ ]\d+D') as dose2
  FROM ODS_DIST.VW_ZEB_COMBINED_QCRESULTS_NL T3, ODS_DIST.VW_ZEB_MERPS_MATERIAL_BATCH T4, ODS_DIST.VW_ZEB_MERPS_MATERIAL_INFO T5
  WHERE (T5.MAT_COD=T4.MAT_COD) AND (T4.BAT_NUM=T3.RECORDED_TEXT)
        AND T5.MAT_DESC LIKE '%%ITMD STRP%%' AND ((T3.TEST_ID IN ('PLT00015313','PLT00015314','PLT00014013','PLT00014155')) OR (T3.TEST_ID='PLT00014207' AND T3.TEST_RESULT_TYPE='Result8'))
  )
ON fill_group1=fill_group2 and dose=dose2 and strength=strength2
ORDER BY material_batch_number, test_method_description, fill_batch, replicate_id ASC
